<template>
    <div class="dashboard-container">
        
        <!-- Header -->
        <div class="header slds-grid slds-grid_align-spread slds-p-vertical_medium">
            <div class="slds-col slds-var-p-left_medium">
                <h1 class="header-title">Admin Command Center</h1>
                <p class="header-subtitle">System Overview â€¢ Production</p>
            </div>
            <div class="slds-col slds-var-p-right_medium slds-grid slds-grid_vertical-align-center">
                
                <!-- Trust Status Badge (Clickable) -->
                <div class="slds-m-right_large slds-grid slds-grid_vertical-align-center trust-clickable" onclick={openDrawer} title="Click for details">
                    <span class="slds-text-heading_small slds-m-right_small" style="font-weight:700; color:#334155;">{trustData.instance}</span>
                    <span class={trustStatusClass}>{trustData.status}</span>
                    <lightning-icon icon-name="utility:info" size="xx-small" class="slds-m-left_x-small info-icon"></lightning-icon>
                </div>

                <lightning-button-icon icon-name="utility:refresh" alternative-text="Refresh" onclick={handleRefresh} variant="border-filled"></lightning-button-icon>
            </div>
        </div>

        <!-- KPI Grid -->
        <div class="slds-grid slds-wrap slds-gutters slds-var-p-horizontal_medium slds-var-m-bottom_large">
            <template for:each={limits} for:item="limit">
                <div key={limit.key} class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3 slds-large-size_1-of-4 slds-var-m-bottom_medium">
                    <div class="card kpi-card">
                        <div class="kpi-header">
                            <h3 class="kpi-label">{limit.label}</h3>
                        </div>
                        <div class="kpi-body slds-grid slds-grid_vertical-align-center">
                            <div class="kpi-text">
                                <p class="kpi-value">{limit.displayUsed}</p>
                                <p class="kpi-total">of {limit.displayTotal}</p>
                            </div>
                            <div class="progress-ring-container">
                                <svg class="progress-ring" width="80" height="80">
                                    <circle class="progress-ring__circle-bg" stroke="#e2e8f0" stroke-width="6" fill="transparent" r="32" cx="40" cy="40"/>
                                    <circle class="progress-ring__circle" stroke={limit.color} stroke-width="6" fill="transparent" r="32" cx="40" cy="40"
                                            stroke-dasharray={limit.circumference} stroke-dashoffset={limit.offset} />
                                </svg>
                                <span class="progress-text">{limit.percent}%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- Main Content Grid -->
        <div class="slds-grid slds-wrap slds-gutters slds-var-p-horizontal_medium">
            <div class="slds-col slds-size_1-of-1 slds-large-size_2-of-3 slds-var-m-bottom_medium">
                <div class="card content-card">
                    <div class="card-header slds-grid slds-grid_align-spread">
                        <h2 class="card-title">Recent Failed Jobs</h2>
                        <lightning-button label="View All" variant="base" class="view-all-btn"></lightning-button>
                    </div>
                    <div class="table-container">
                        <template if:true={failedJobs}>
                            <lightning-datatable
                                key-field="Id"
                                data={failedJobs}
                                columns={jobColumns}
                                hide-checkbox-column>
                            </lightning-datatable>
                        </template>
                        <template if:false={failedJobs}>
                            <div class="slds-p-around_medium slds-text-align_center text-gray">No failed jobs found. High five!</div>
                        </template>
                    </div>
                </div>
            </div>

            <div class="slds-col slds-size_1-of-1 slds-large-size_1-of-3 slds-var-m-bottom_medium">
                <div class="card content-card">
                    <div class="card-header">
                        <h2 class="card-title">License Usage</h2>
                    </div>
                    <div class="slds-p-around_medium">
                        <template for:each={licenses} for:item="lic">
                            <div key={lic.Id} class="license-item slds-var-m-bottom_medium">
                                <div class="slds-grid slds-grid_align-spread slds-var-m-bottom_xx-small">
                                    <span class="license-name">{lic.Name}</span>
                                    <span class="license-stats"><strong>{lic.UsedLicenses}</strong> / {lic.TotalLicenses}</span>
                                </div>
                                <div class="progress-bar-bg">
                                    <div class={lic.barClass} style={lic.styleWidth}></div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- DRAWER / SLIDE-OUT PANEL -->
        <template if:true={isDrawerOpen}>
            <div class="drawer-backdrop" onclick={closeDrawer}></div>
            <div class="drawer-panel slide-in-right">
                
                <!-- Drawer Header -->
                <div class="drawer-header slds-grid slds-grid_align-spread slds-p-around_medium slds-border_bottom">
                    <h2 class="slds-text-heading_medium slds-truncate">System Status: {trustData.instance}</h2>
                    <lightning-button-icon icon-name="utility:close" variant="bare" size="medium" onclick={closeDrawer}></lightning-button-icon>
                </div>

                <!-- Drawer Content -->
                <div class="drawer-content slds-p-around_medium">
                    
                    <!-- General Info -->
                    <div class="slds-box slds-theme_shade slds-m-bottom_medium">
                        <ul class="slds-list_horizontal slds-has-dividers_right slds-text-body_small slds-wrap">
                            <li class="slds-item">Version: <strong>{trustData.releaseVersion}</strong></li>
                            <li class="slds-item">Next: <strong>{trustData.nextReleaseName}</strong></li>
                            <li class="slds-item">Date: <strong>{trustData.nextReleaseDate}</strong></li>
                            <li class="slds-item">Status: <strong class={trustStatusClass}>{trustData.status}</strong></li>
                        </ul>
                    </div>

                    <!-- Incidents Section -->
                    <div class="slds-text-heading_small slds-m-bottom_small">Incident Status</div>
                    
                    <template if:true={hasIncidents}>
                        <div class="slds-m-bottom_medium">
                            <template for:each={trustData.incidents} for:item="inc">
                                <div key={inc.id} class="slds-box slds-theme_warning slds-m-bottom_small">
                                    <p class="slds-text-title_bold slds-m-bottom_xx-small">{inc.serviceKeys}</p>
                                    <p class="slds-m-bottom_small">{inc.message}</p>
                                    
                                    <!-- Vertical Timeline -->
                                    <template if:true={inc.formattedEvents}>
                                        <div class="slds-p-top_small slds-border_top slds-text-body_small" style="border-color: rgba(0,0,0,0.1);">
                                            <div class="slds-text-title_caps slds-m-bottom_small" style="opacity:0.7;">Event Log</div>
                                            
                                            <div class="timeline">
                                                <template for:each={inc.formattedEvents} for:item="evt">
                                                    <div key={evt.id} class="timeline-item">
                                                        <div class="timeline-marker"></div>
                                                        <div class="timeline-content">
                                                            <div class="timeline-date">{evt.displayDate}</div>
                                                            <div class="timeline-message">{evt.message}</div>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>

                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </template>
                    
                    <!-- NO Incidents Hero State -->
                    <template if:false={hasIncidents}>
                         <div class="trust-hero">
                             <lightning-icon icon-name="utility:shield" size="large" class="trust-hero-icon"></lightning-icon>
                             <h2 class="trust-hero-title">All Systems Operational</h2>
                             <p class="trust-hero-subtitle">No active incidents reported for your instance.</p>
                        </div>
                    </template>

                    <!-- Previous Incidents (Collapsible) -->
                    <template if:true={hasResolvedIncidents}>
                        <div class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center slds-m-bottom_small collapsible-header" onclick={toggleResolvedIncidents}>
                            <h3 class="slds-text-heading_small">Previous Incidents</h3>
                            <lightning-icon icon-name={resolvedIncidentsIcon} size="x-small" class="chevron-icon"></lightning-icon>
                        </div>
                        
                        <template if:true={isResolvedIncidentsExpanded}>
                            <div class="slds-m-bottom_medium slide-in-top">
                                <template for:each={trustData.resolvedIncidents} for:item="inc">
                                    <div key={inc.id} class="slds-box slds-theme_shade slds-m-bottom_small resolved-box">
                                        <div class="slds-grid slds-grid_align-spread slds-m-bottom_x-small">
                                            <span class="slds-text-title_bold">{inc.serviceKeys}</span>
                                            <span class="slds-badge">Resolved</span>
                                        </div>
                                        <p class="slds-m-bottom_small slds-text-body_small">{inc.message}</p>

                                        <!-- Simple Timeline for Resolved -->
                                        <template if:true={inc.formattedEvents}>
                                             <div class="timeline">
                                                <template for:each={inc.formattedEvents} for:item="evt">
                                                    <div key={evt.id} class="timeline-item">
                                                        <div class="timeline-marker resolved-marker"></div>
                                                        <div class="timeline-content">
                                                            <div class="timeline-date">{evt.displayDate}</div>
                                                            <div class="timeline-message">{evt.message}</div>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </template>


                    <!-- Sub-Services List (Collapsible) -->
                    <div class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center slds-m-bottom_small collapsible-header" onclick={toggleServiceHealth}>
                        <h3 class="slds-text-heading_small">Service Health</h3>
                        <lightning-icon icon-name={serviceHealthIcon} size="x-small" class="chevron-icon"></lightning-icon>
                    </div>

                    <template if:true={isServiceHealthExpanded}>
                        <div class="service-list slide-in-top">
                            <template for:each={formattedServices} for:item="svc">
                                <div key={svc.key} class={svc.rowClass}>
                                    <div class="slds-grid slds-grid_vertical-align-center">
                                        <lightning-icon icon-name={svc.iconName} variant={svc.iconVariant} size="xx-small" class="slds-m-right_small"></lightning-icon>
                                        <span class="service-name">{svc.name}</span>
                                    </div>
                                    <span class="service-status">{svc.status}</span>
                                </div>
                            </template>
                        </div>
                    </template>

                </div>
            </div>
        </template>
    </div>
</template>