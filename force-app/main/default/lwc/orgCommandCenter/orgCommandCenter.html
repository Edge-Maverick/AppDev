<template>
    <div class="dashboard-container">
        
        <!-- Header -->
        <div class="header slds-grid slds-grid_align-spread slds-p-vertical_medium">
            <div class="slds-col slds-var-p-left_medium">
                <h1 class="header-title">Admin Command Center</h1>
                <p class="header-subtitle">System Overview â€¢ Production</p>
                
                <!-- MAINTENANCE ALERT BANNER -->
                <template if:true={showMaintenanceAlert}>
                    <div class="maintenance-alert slds-m-top_small slide-in-top">
                        <div class="slds-grid slds-grid_vertical-align-center">
                            <lightning-icon icon-name="utility:warning" size="x-small" variant="warning" class="slds-m-right_small"></lightning-icon>
                            <span class="alert-text">
                                <strong>Upcoming Maintenance:</strong> {trustData.nextMaintenance.title} on {trustData.nextMaintenance.dateStr}
                            </span>
                        </div>
                        <lightning-button-icon icon-name="utility:close" variant="bare" size="small" onclick={closeAlert} class="close-alert-btn"></lightning-button-icon>
                    </div>
                </template>

            </div>
            <div class="slds-col slds-var-p-right_medium slds-grid slds-grid_vertical-align-center">
                
                <!-- Trust Status Badge (Clickable) -->
                <div class="slds-m-right_large slds-grid slds-grid_vertical-align-center trust-clickable" onclick={openDrawer} title="Click for details">
                    <span class="slds-text-heading_small slds-m-right_small" style="font-weight:700; color:#334155;">{trustData.instance}</span>
                    <span class={trustStatusClass}>{trustData.status}</span>
                    <lightning-icon icon-name="utility:info" size="xx-small" class="slds-m-left_x-small info-icon"></lightning-icon>
                </div>

                <lightning-button-icon icon-name="utility:refresh" alternative-text="Refresh" onclick={handleRefresh} variant="border-filled"></lightning-button-icon>
            </div>
        </div>

        <!-- KPI Grid -->
        <div class="slds-grid slds-wrap slds-gutters slds-var-p-horizontal_medium slds-var-m-bottom_large">
            <template for:each={limits} for:item="limit">
                <div key={limit.key} class="slds-col slds-size_1-of-1 slds-medium-size_1-of-3 slds-large-size_1-of-4 slds-var-m-bottom_medium">
                    <div class="card kpi-card">
                        <div class="kpi-header">
                            <h3 class="kpi-label">{limit.label}</h3>
                        </div>
                        <div class="kpi-body slds-grid slds-grid_vertical-align-center">
                            <div class="kpi-text">
                                <p class="kpi-value">{limit.displayUsed}</p>
                                <p class="kpi-total">of {limit.displayTotal}</p>
                            </div>
                            <div class="progress-ring-container">
                                <svg class="progress-ring" width="80" height="80">
                                    <circle class="progress-ring__circle-bg" stroke="#e2e8f0" stroke-width="6" fill="transparent" r="32" cx="40" cy="40"/>
                                    <circle class="progress-ring__circle" stroke={limit.color} stroke-width="6" fill="transparent" r="32" cx="40" cy="40"
                                            stroke-dasharray={limit.circumference} stroke-dashoffset={limit.offset} />
                                </svg>
                                <span class="progress-text">{limit.percent}%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- DRAWER / SLIDE-OUT PANEL -->
        <template if:true={isDrawerOpen}>
            <div class="drawer-backdrop" onclick={closeDrawer}></div>
            <div class="drawer-panel slide-in-right">
                
                <!-- Drawer Header -->
                <div class="drawer-header slds-grid slds-grid_align-spread slds-p-around_medium slds-border_bottom">
                    <h2 class="slds-text-heading_medium slds-truncate">System Status: {trustData.instance}</h2>
                    <lightning-button-icon icon-name="utility:close" variant="bare" size="medium" onclick={closeDrawer}></lightning-button-icon>
                </div>

                <!-- Drawer Content -->
                <div class="drawer-content slds-p-around_medium">
                    
                    <!-- General Info (Updated to Grid Layout with Consistent Alignment) -->
                    <div class="slds-box slds-theme_shade slds-m-bottom_medium">
                        <div class="slds-grid slds-wrap slds-gutters_x-small">
                            <!-- Release Info (2/3 width) -->
                            <div class="slds-col slds-size_2-of-3 slds-m-bottom_x-small">
                                <div class="slds-text-color_weak slds-text-body_small">Version</div>
                                <div class="slds-text-body_small slds-truncate" title={trustData.releaseVersion}><strong>{trustData.releaseVersion}</strong></div>
                            </div>
                            <!-- API Info (1/3 width) -->
                            <div class="slds-col slds-size_1-of-3 slds-m-bottom_x-small">
                                <div class="slds-text-color_weak slds-text-body_small">API Level</div>
                                <div class="slds-text-body_small"><strong>{trustData.apiVersion}</strong></div>
                            </div>
                            
                            <!-- Divider for Upcoming -->
                            <div class="slds-col slds-size_1-of-1 slds-m-top_x-small slds-border_top slds-p-top_small">
                                <!-- Nested Grid with consistent widths -->
                                <div class="slds-grid slds-wrap slds-gutters_x-small">
                                    <div class="slds-col slds-size_2-of-3">
                                        <div class="slds-text-color_weak slds-text-body_small">Next Update</div>
                                        <div class="slds-text-body_small slds-truncate" title={trustData.nextReleaseName}><strong>{trustData.nextReleaseName}</strong></div>
                                    </div>
                                    <div class="slds-col slds-size_1-of-3">
                                        <div class="slds-text-color_weak slds-text-body_small">Date</div>
                                        <div class="slds-text-body_small"><strong>{trustData.nextReleaseDate}</strong></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Incident Status -->
                    <div class="slds-text-heading_small slds-m-bottom_small">Incident Status</div>
                    
                    <template if:true={hasIncidents}>
                        <div class="slds-m-bottom_medium">
                            <template for:each={trustData.incidents} for:item="inc">
                                <div key={inc.id} class="slds-box slds-theme_warning slds-m-bottom_small">
                                    <p class="slds-text-title_bold slds-m-bottom_xx-small">{inc.serviceKeys}</p>
                                    <p class="slds-m-bottom_small">{inc.message}</p>
                                    
                                    <!-- Vertical Timeline -->
                                    <template if:true={inc.formattedEvents}>
                                        <div class="slds-p-top_small slds-border_top slds-text-body_small" style="border-color: rgba(0,0,0,0.1);">
                                            <div class="slds-text-title_caps slds-m-bottom_small" style="opacity:0.7;">Event Log</div>
                                            
                                            <div class="timeline">
                                                <template for:each={inc.formattedEvents} for:item="evt">
                                                    <div key={evt.id} class="timeline-item">
                                                        <div class="timeline-marker"></div>
                                                        <div class="timeline-content">
                                                            <div class="timeline-date">{evt.displayDate}</div>
                                                            <div class="timeline-message">{evt.message}</div>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>

                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </template>
                    
                    <!-- NO Incidents Hero State (Updated Illustration & Micro-interactions) -->
                    <template if:false={hasIncidents}>
                         <div class="trust-hero">
                             <!-- Custom SVG Illustration for "Success/Check" -->
                             <div class="trust-hero-illustration-container">
                                 <svg class="trust-hero-svg" viewBox="0 0 200 150" aria-hidden="true">
                                     <path fill="#dcfce7" d="M40.2,149.3c-8.3,0-15.3-6.4-16.1-14.7L18.7,78.2c-0.4-4.2,1.1-8.3,4.2-11.2l43-41c6.1-5.8,15.7-5.8,21.8,0l43,41c3.1,2.9,4.6,7.1,4.2,11.2l-5.4,56.4c-0.8,8.3-7.8,14.7-16.1,14.7H40.2z" />
                                     <path fill="#22c55e" d="M142.6,96.4c-1.5,0-3-0.6-4.1-1.8l-18.6-18.6c-2.3-2.3-2.3-6,0-8.3s6-2.3,8.3,0l14.5,14.5l35.3-35.3c2.3-2.3,6-2.3,8.3,0s2.3,6,0,8.3l-39.5,39.5C145.6,95.8,144.1,96.4,142.6,96.4z"/>
                                     <circle fill="#86efac" cx="90" cy="90" r="10" opacity="0.6" />
                                     <circle fill="#4ade80" cx="160" cy="40" r="5" opacity="0.8" />
                                     <circle fill="#bbf7d0" cx="30" cy="50" r="8" opacity="0.5" />
                                 </svg>
                             </div>
                             <h2 class="trust-hero-title">All Systems Operational</h2>
                             <p class="trust-hero-subtitle">No active incidents reported for your instance.</p>
                             <p class="trust-hero-timestamp slds-text-body_small slds-m-top_x-small">Last checked: Just now</p>
                        </div>
                    </template>

                    <!-- Previous Incidents (Collapsible) -->
                    <template if:true={hasResolvedIncidents}>
                        <div class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center slds-m-bottom_small collapsible-header" onclick={toggleResolvedIncidents}>
                            <h3 class="slds-text-heading_small">Previous Incidents</h3>
                            <lightning-icon icon-name={resolvedIncidentsIcon} size="x-small" class="chevron-icon"></lightning-icon>
                        </div>
                        
                        <template if:true={isResolvedIncidentsExpanded}>
                            <div class="slds-m-bottom_medium slide-in-top">
                                <template for:each={trustData.resolvedIncidents} for:item="inc">
                                    <div key={inc.id} class="slds-box slds-theme_shade slds-m-bottom_small resolved-box">
                                        <div class="slds-grid slds-grid_align-spread slds-m-bottom_x-small">
                                            <span class="slds-text-title_bold">{inc.serviceKeys}</span>
                                            <span class="slds-badge">Resolved</span>
                                        </div>
                                        <p class="slds-m-bottom_small slds-text-body_small">{inc.message}</p>

                                        <!-- Simple Timeline for Resolved -->
                                        <template if:true={inc.formattedEvents}>
                                             <div class="timeline">
                                                <template for:each={inc.formattedEvents} for:item="evt">
                                                    <div key={evt.id} class="timeline-item">
                                                        <div class="timeline-marker resolved-marker"></div>
                                                        <div class="timeline-content">
                                                            <div class="timeline-date">{evt.displayDate}</div>
                                                            <div class="timeline-message">{evt.message}</div>
                                                        </div>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </template>

                    <!-- Sub-Services List (Collapsible) -->
                    <div class="slds-grid slds-grid_align-spread slds-grid_vertical-align-center slds-m-bottom_small collapsible-header" onclick={toggleServiceHealth}>
                        <h3 class="slds-text-heading_small">Service Health</h3>
                        <lightning-icon icon-name={serviceHealthIcon} size="x-small" class="chevron-icon"></lightning-icon>
                    </div>

                    <template if:true={isServiceHealthExpanded}>
                        <div class="service-list slide-in-top">
                            <template for:each={formattedServices} for:item="svc">
                                <div key={svc.key} class={svc.rowClass}>
                                    <div class="slds-grid slds-grid_vertical-align-center">
                                        <lightning-icon icon-name={svc.iconName} variant={svc.iconVariant} size="xx-small" class="slds-m-right_small"></lightning-icon>
                                        <span class="service-name">{svc.name}</span>
                                    </div>
                                    <span class="service-status">{svc.status}</span>
                                </div>
                            </template>
                        </div>
                    </template>

                </div>
            </div>
        </template>
    </div>
</template>